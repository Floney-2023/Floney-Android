name: Android Dev Test

on:
  push:
    branches:
      - release/floney-ver.3

jobs:
  build-and-distribute-debug:
    runs-on: ubuntu-latest

    env:
      LOCAL_PROPERTIES_CONTENTS: ${{ secrets.LOCAL_PROPERTIES_CONTENTS }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Create file
        run: cat presentation/google-services.json | base64

      - name: Putting data
        env:
          DATA: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: echo $DATA > presentation/google-services.json

      - name: Create local.properties
        run: echo "$LOCAL_PROPERTIES_CONTENTS" > local.properties

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew :presentation:assembleDebug

      - name: Extract versionName from build.gradle
        id: version
        run: echo "version_name=$(grep versionName app/build.gradle | head -1 | awk -F\\\" '{print $2}')" >> $GITHUB_OUTPUT

      - name: Read release notes
        id: notes
        run: |
          notes=$(cat releasenotes.txt | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "release_notes=$notes" >> $GITHUB_OUTPUT

      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      - name: Find Debug APK Path
        run: |
          apk_path=$(find presentation/build -name "*.apk" | head -n 1)
          echo "apk_path=$apk_path"
          echo "APK_PATH=$apk_path" >> $GITHUB_ENV

      - name: Distribute Debug APK
        run: |
          firebase appdistribution:distribute $APK_PATH \
            --app "${{ secrets.FIREBASE_APP_ID }}" \
            --groups "Floney-Android-Tester" \
            --release-notes "$(cat releasenotes.txt)" \
            --token "${{ secrets.FIREBASE_TOKEN }}"


      - name: Notify Slack
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ğŸš€ *Floney Debug v${{ steps.version.outputs.version_name }} ë°°í¬ ì™„ë£Œ!*\nğŸ“ *Release Notes:*\n${{ steps.notes.outputs.release_notes }}\"
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
